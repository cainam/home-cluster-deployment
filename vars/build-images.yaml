builder:
  base: "/data/build/"
  build_dir: work
  default_builder: my_builder
  makeopts: "-j4"
  chost: 'aarch64-unknown-linux-musl'
  stage3_base: stage3-arm64-musl-hardened
  stage3_date: 20260201T231555Z
  stage3_dateX: 20260112T121559Z
  portage: 20260202
  portageX: 20260112
  portage_container: "portage"
  image_root: /image-root
  env: |
      ENV PKGDIR="/packages/aarch64-unknown-linux-musl"
      ENV DISTDIR="/distfiles"
      ENV FEATURES="-parallel-fetch nodoc noinfo noman binpkg-multi-instance -ipc-sandbox -network-sandbox -pid-sandbox"
      ENV EMERGE_DEFAULT_OPTS="-b -k --binpkg-respect-use=y --quiet-build"
      ENV EMERGE_OPT="-v --tree"
      ENV USE="bindist threads -nls -X -gnome -gtk -kde -qt4 -cups -alsa -cups -ipv6 -pppd -gdbm -gpm -pam -ncurses -debug -doc -kerberos -ldap -pam -perl -systemd -tcl -test -su -seccomp -udev -systemd"
      ENV static_libs_use="-static-libs"
      ENV LDFLAGS="-static-libgcc -static-libstdc++"
      ENV NODOC=true
      ENV NOINFO=true
      ENV NOMAN=true
      ENV LINGUAS="en"
      ENV L10N="en"
      ENV ACCEPT_LICENSE="*"
      ENV MAKEOPTS="-j3"
  configure_builder: |
      python_version=3.13
      echo 'INSTALL_MASK="${INSTALL_MASK} /usr/share/doc /usr/share/info"' >>  /etc/portage/make.conf
      cat >> /etc/portage/package.use/builder.conf <<EOF
      sys-devel/binutils gold
      dev-vcs/git -perl
      app-crypt/pinentry ncurses
      */* PYTHON_TARGETS: -* python${python_version//./_}
      */* PYTHON_SINGLE_TARGET: -* python${python_version//./_}
      EOF
      # overlay
      mkdir -p /etc/portage/repos.conf/
      echo -e "[local]\nlocation = /portage-local\npriority = 9999" > /etc/portage/repos.conf/local.conf

      mkdir -p /etc/portage/package.{accept_keywords,unmask,mask,use}
      # mask all unwanted python version
      qlist -Iv | grep "^dev-lang/python-[0-9]" | grep -v "dev-lang/python-${python_version}" | sed -e 's/^/=/g' >> /etc/portage/package.mask/python
      source /etc/profile
      emerge --newuse sys-apps/portage app-portage/gentoolkit dev-vcs/git # app-portage/flaggie app-portage/eix app-portage/gentoolkit
      remove="virtual/ssh virtual/service-manager sys-apps/elfix sys-libs/libseccomp dev-python/pypax virtual/udev sys-apps/systemd-utils virtual/dev-manager net-misc/dhcpcd net-misc/iputils sys-apps/openrc sys-apps/net-tools app-editors/nano sys-apps/help2man sys-apps/iproute2 sys-apps/kmod sys-apps/man-db  sys-apps/texinfo virtual/man net-mail/mailbase"
      for p in sys-devel/gcc sys-devel/gcc-config sys-apps/systemd-utils; do equery --quiet --no-color --no-pipe list "${p}" >> /etc/portage/profile/package.provided; done
      emerge --unmerge ${remove} $(sed -e 's/^=//g' /etc/portage/package.mask/* | xargs)
      emerge --newuse --deep @installed --tree
      emerge --depclean
      emerge @preserved-rebuild
  finish_build: |
      qlist -C -I -v --root ${ROOT}/ > /package.provided-${image}
      cp -rdp ${ROOT}/var/db/pkg /pkg-${image} 
      rm -rf ${ROOT}/var/db/pkg ${ROOT}/usr/include ${ROOT}/var/cache/* ${ROOT}/var/lib/gentoo ${ROOT}/var/lib/portage ${ROOT}/etc/conf.d ${ROOT}/etc/init.d ${ROOT}/etc/portage
      [ -d "${ROOT}" ] && find ${ROOT}/ -type f -name "*.a" -delete
      true
