images:
- name: base
  section: local
  type: gentoo-image-builder
  test: sh -c 'busybox sh --help'
  build:
    packages: busybox
    finish_rootfs_build: ln -s usr/lib "${ROOT}/lib" && "${ROOT}"/bin/busybox --install "${ROOT}/bin"

- name: pilot
  tag: "{{ software.istio.version }}"
  section: istio-system
  type: gentoo-image-builder
  requires:
  - go
  build:
    entrypoint: ["/usr/local/bin/pilot-discovery"]
    user: 1337
    configure_rootfs_build: |
      cd /var/tmp
      git clone --depth 1 --single-branch -b release-1.27 https://github.com/istio/istio.git
      cd istio/pilot/cmd/pilot-discovery
      CGO_ENABLED=0 go build -ldflags '-extldflags "-static" -s -w'
    finish_rootfs_build: |
      echo 'istio-proxy:x:1337:istio-proxy' > "${ROOT}/etc/group"
      echo 'istio-proxy:x:1337:1337:Linux User,,,:/home/istio-proxy:/bin/sh' > "${ROOT}/etc/passwd"
      mkdir -p "${ROOT}/usr/local/bin" && cp -dp pilot-discovery "${ROOT}/usr/local/bin"
      rm -rf /root/go /root/.cache

- name: postgresql
  section: db
  type: gentoo-image-builder
  requires:
  - base
  env:
    PATH: /usr/lib/postgresql-{{ software.postgresql.version|string|split('.')|first }}/bin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  build:
    entrypoint: ["/usr/bin/postgres"]
    user: postgres
    packages: ="{{ software.postgresql.latest.params.repo }}"-"{{ software.postgresql.version }}"
    configure_builder: |
      mkdir -p /etc/portage/env /etc/portage/package.use
      echo "EXTRA_ECONF=\"LDFLAGS='-Wl,-Bstatic -latomic -Wl,-Bdynamic'\"" > /etc/portage/env/postgres-static-atomic
      echo "dev-db/postgresql postgres-static-atomic" >> /etc/portage/package.env
      echo "dev-db/postgresql -numa" >> /etc/portage/package.use/postgresql
    finish_rootfs_build: |
      ln -s usr/lib "${ROOT}/lib" # && copy_gcc_libs
      (cd ${ROOT}/usr/bin; for f in usr/lib/postgresql*/bin/*; do b=$(basename $f); if [ -e "${b}" ]; then echo "usr/bin/$b exists"; else ln -s /$f; fi; done)
      mkdir -p -m 3777 ${ROOT}/run/postgresql && chown 70 ${ROOT}/run/postgresql
      echo 'postgres:x:70:70:PostgreSQL program user:/var/lib/postgresql:/bin/sh' > "${ROOT}/etc/passwd"
      echo 'postgres:x:70:' > "${ROOT}/etc/group"

- name: go
  section: local
  type: gentoo-image-builder
  requires:
  - base
  build:
    configure_builder: emerge dev-lang/go
    configure_rootfs_build: touch "${ROOT}/ready2go"
      
- name: hydra
  section: auth
  type: gentoo-image-builder
  requires:
  - go
  build:
    configure_rootfs_build: |
      git clone --branch "{{ software.hydra.version }}" --depth 1 --filter=blob:none  https://github.com/ory/hydra.git
      cd hydra
      go build -tags sqlite,sqlite_omit_load_extension .
      strip hydra
      mv hydra "${ROOT}/bin/"

- name: descheduler
  section: kube-system
  type: gentoo-image-builder
  requires:
  - go
  build:
    configure_rootfs_build: |
      git clone --branch "{{ software.descheduler.version }}" --depth 1 --filter=blob:none https://github.com/kubernetes-sigs/descheduler.git
      cd descheduler
      make
      strip ./_output/bin/descheduler
      mkdir -p "${ROOT}/bin"
      mv  ./_output/bin/descheduler "${ROOT}/bin/"

- name: traefik
  section: gateway
  type: gentoo-image-builder
  requires:
  - go
  build:
    configure_builder: |
      echo "net-libs/nodejs npm corepack" > /etc/portage/package.use/97nodejs.conf
      mkdir -p /var/tmp/portage
      mkdir -p /var/db && chmod 755 /var/db
      PORTAGE_TMPDIR="/var/tmp/portage" MAKEOPTS="-j3" emerge net-libs/nodejs dev-libs/icu
    configure_rootfs_build: |
      git clone --depth 1 --single-branch -b "{{ software.traefik.version }}" https://github.com/traefik/traefik.git
      set -x
      cd traefik/webui
      corepack enable
      sed -i -e 's/^}$/,"optionalDependencies": {"@rollup\/rollup-linux-x64-musl": "4.9.5"}}/g' package.json
      rm yarn.lock # ???
      echo "Y" | yarn install
      echo "Y" | yarn workspaces focus --all --production # to keep only production ready deps
      ##npm install -D vitest@^4 @vitest/coverage-v8@^4
      ##npm i
      ##yarn install
      #yarn build
      cd ..
      #(go run ./cmd/internal/gen/ || true)
      #(./script/code-gen.sh || true)
      go generate
      go build -ldflags "-w -s" ./cmd/traefik
    finish_rootfs_build: |
      mkdir -p "${ROOT}/bin" && cp -dp ./traefik "${ROOT}/bin"

- name: oauth2-proxy
  section: auth
  type: gentoo-image-builder
  requires:
  - go
  build:
    entrypoint: ["/bin/oauth2-proxy"]
    configure_rootfs_build: |
      git clone -b "{{ software['oauth2-proxy'].version }}" https://github.com/oauth2-proxy/oauth2-proxy.git
      cd oauth2-proxy
      go build
      strip  oauth2-proxy
      mkdir -p "${ROOT}/bin"
      mv oauth2-proxy "${ROOT}/bin/"
      cd && rm -rf /oauth2-proxy /root/.??* /root/*

- name: registry
  section: local
  type: gentoo-image-builder
  requires:
  - go
  build:
    entrypoint: ["/bin/registry"]
    configure_rootfs_build: |
      git clone -b "{{ software.registry.version }}" https://github.com/distribution/distribution.git
      cd distribution
      make bin/registry
      strip bin/registry
      mkdir "${ROOT}/bin"
      mv bin/registry "${ROOT}/bin/"
      cd ..
      rm -rf distribution /root/.??* /root/*

- name: nodejs
  section: local
  type: gentoo-image-builder
  requires:
  - base
  build:
    packages: net-libs/nodejs
    configure_builder: |
      echo "net-libs/nodejs npm corepack" > /etc/portage/package.use/97nodejs.conf
      echo "dev-lang/typescript ~arm64" > /etc/portage/package.accept_keywords/ts.conf && cat /etc/portage/package.accept_keywords/ts.conf
      MAKEOPTS="-j3" emerge --tree --verbose net-libs/nodejs dev-lang/typescript
    configure_rootfs_build: |
      ln -s usr/lib "${ROOT}/lib"
    finish_rootfs_build: |
      ln -s ../../bin/env "${ROOT}/usr/bin/env"

- name: idp
  section: auth
  type: gentoo-image-builder
  requires:
  - nodejs
  workdir: /app
  build:
    entrypoint: ["/bin/sh", "-c", "npm run serve"]
    configure_rootfs_build: |
      git_url="https://github.com/cainam/sufficient_idp.git"
      git=$(basename "{{ own_git_url }}" | sed -e 's/\.git$//g')
      git clone --single-branch --branch main --depth 1 --filter=blob:none "${git_url}"
      mkdir -p "${ROOT}/app" && mv sufficient_idp/idp/* "${ROOT}/app/"
      rm -rf "${git}"
    finish_rootfs_build: |
      cd "${ROOT}/app/"
      npm ci && npm run build
      npm prune --omit=dev

- name: zigbee2mqtt
  section: home
  type: gentoo-image-builder
  requires:
  - nodejs
  workdir: /app
  env:
    HOME: /app
    PATH: /app/bin:/bin:/usr/bin
  build:
    entrypoint: ["/bin/sh", "-c", "node index.js"]
    configure_rootfs_build: |
      git clone --branch {{ software.zigbee2mqtt.version }} --depth 1 https://github.com/Koenkk/zigbee2mqtt.git "${ROOT}/app"
    finish_rootfs_build: |
      cd "${ROOT}/app/"
      mkdir log
      npm install
      npm run build
      npm rebuild --build-from-source # otherwise segfault- to be tested: cannot it be merge with previous commands?
      npm prune --omit=dev --omit=optional

- name: python3
  section: local
  requires:
  - base
  env:
    LD_LIBRARY_PATH: /usr/local/lib
  type: gentoo-image-builder
  build:
    packages: "dev-python/packaging dev-python/gpep517"
    Xconfigure_builder: emerge dev-python/pip
    configure_rootfs_build: |
      echo "*/* sqlite" >> /etc/portage/package.use/builder.conf
      # provide_package sys-devel/gcc
      ln -s usr/lib "${ROOT}/lib"
      # add user/group for unprivileged container usage
      groupadd -g 404 python
      useradd -u 4004 -g python -d /home/python python
      mkdir -p "${ROOT}"/home/python
    finish_rootfs_build: mkdir -p "${ROOT}/usr/local/lib"; for lib in $(find /usr/lib/ -name libgomp.so.1); do cp "${lib}" "${ROOT}/usr/local/lib"; done

- name: ha-base
  section: home
  requires:
  - python3
  type: gentoo-image-builder
  build:
    packages: "app-misc/jq app-crypt/gnupg dev-python/jinja2 dev-python/idna dev-python/certifi dev-python/requests dev-python/python-dateutil"
    run_with: python3 -m homeassistant --config /config --log-file /tmp/log --skip-pip

- name: home-assistant
  section: home
  requires:
  - ha-base
  type: gentoo-image-builder
  env:
    LD_LIBRARY_PATH: /usr/lib/postgresql-18/lib/:/usr/local/lib
  build:
    packages: dev-db/postgresql
    configure_builder: |
      sed -i -e '/oniguruma/d' -e '/jq/d' /etc/portage/profile/package.provided
      # echo 'dev-db/postgresql -server' > /etc/portage/package.use/postgresql
      # openjade includes opensp whose build breaks https://github.com/Distrotech/OpenSP/blob/master/intl/dcigettext.c - line 154 invalid getcwd definition
      #(cd /var/db/repos/gentoo/dev-db/postgresql/; for f in postgresql-*; do sed -i -e '/openjade/d' $f; ebuild $f manifest; done)
      emerge app-misc/jq 
    configure_rootfs_build: |
      set -x
      HA_DIR=/ha && mkdir -p ${ROOT}/${HA_DIR} && ln -s ${ROOT}/${HA_DIR} ${HA_DIR}
      ( cd ${ROOT}/${HA_DIR}; 
          git clone --depth=1 -b "{{ software['home-assistant'].version }}" https://github.com/home-assistant/core.git
          cd core
          for package in pyspeex-noise home-assistant-intents PyTurboJPEG home-assistant-frontend pyotp PyQRCode paho-mqtt hassil numpy mutagen ha-ffmpeg hass-nabucasa pymicro-vad; do # pyudev; do
            grep -q "${package}==" requirements.txt  || grep "^${package}==" requirements_all.txt >> requirements.txt
          done
            
          sed -i -e "/hass_nabucasa/d" -e "s#remote.is_cloud_request.get()#False#" homeassistant/components/http/forwarded.py
            
          # remove from default configuration
          cp -dp homeassistant/components/default_config/manifest.json homeassistant/components/default_config/manifest.json.org
          jq  -a 'del(.dependencies[] | select(. == ("assist_pipeline","stream","go2rtc","cloud","conversation","zeroconf","usb","ssdp","dhcp","mobile_app","bluetooth") ) )' homeassistant/components/default_config/manifest.json.org > homeassistant/components/default_config/manifest.json
      )
      
      VIRTUAL_ENV=/py_env
      python -m venv --system-site-packages "$VIRTUAL_ENV" && . "$VIRTUAL_ENV"/bin/activate
      pip install --no-cache-dir -r ${HA_DIR}/core/requirements.txt 2>&1 | tee ${ROOT}/py_env.log
      rm -rf /py_env/lib/python3.13/site-packages/hass_frontend/frontend_es5 # remove this ancient version 
      set +x
    finish_rootfs_build: |
      VIRTUAL_ENV=/py_env
      . "$VIRTUAL_ENV"/bin/activate
      ln -s ${ROOT}/usr/bin/pg_config* /usr/bin/pg_config
      pip --no-cache-dir install psycopg2
      find /py_env -name '*.so*' -exec strip {} \;
      pip uninstall --yes uv
      mv "$VIRTUAL_ENV" ${ROOT}/"$VIRTUAL_ENV"

- name: mosquitto
  section: home
  requires:
  - base
  type: gentoo-image-builder
  build:
    entrypoint: ["/mosquitto/sbin/mosquitto", "-c", "/mosquitto/config/mosquitto.conf" ]
    packages: dev-libs/cJSON dev-libs/openssl net-libs/libwebsockets net-libs/libwebsockets
    finish_rootfs_build: |
      git clone --depth=1 -b "{{ software.mosquitto.version }}" https://github.com/eclipse-mosquitto/mosquitto.git
      mv mosquitto src && cd src
      sed -i -e 's#/usr/local#/mosquitto#g' config.mk
      export CFLAGS="-I${ROOT}/usr/include"
      export LDFLAGS="-L${ROOT}/usr/lib"
      make install WITH_DOCS=no WITH_WEBSOCKETS=yes
      mv /mosquitto ${ROOT}/mosquitto
      echo "mosquitto:x:1883:" >> ${ROOT}/etc/group
      echo "mosquitto:x:1883:1883:mosquitto:/var/empty:/sbin/nologin" >> ${ROOT}/etc/passwd
      strip ${ROOT}/usr/lib/* ${ROOT}/usr/bin/* ${ROOT}/usr/sbin/* || true

- name: bazel
  tag: 2025.09-1
  section: local
  requires:
  - python3
  type: gentoo-image-builder
  env:
    JAVA_HOME: /opt/zulu
    USER: root
  build:
    packages: app-arch/zip
    configure_builder: emerge app-arch/zip
    finish_rootfs_build: |
      zulu=zulu21.46.19-ca-jdk21.0.9-linux_musl_aarch64.tar.gz
      ZULU_DIR=/opt/zulu
      curl -O https://cdn.azul.com/zulu/bin/$zulu
      mkdir -p "${ZULU_DIR}" && tar --directory "${ZULU_DIR}" --extract --strip-components=1 --file  $zulu
      export  JAVA_HOME=$ZULU_DIR
      export PATH=$JAVA_HOME/bin:$PATH

      bazel_version=8.4.2
      bazel_dist=bazel-$bazel_version-dist.zip
      mkdir /bazel
      cd bazel
      curl -L -O https://github.com/bazelbuild/bazel/releases/download/$bazel_version/$bazel_dist
      unzip -q $bazel_dist
      curl "https://gitlab.alpinelinux.org/alpine/aports/-/raw/e49daeab5c9554e8cb7ca23547037d6659d7be43/testing/bazel8/0001-off64t-fix.patch?inline=false" -O

      # 8.4 bazel zip, patch applied, but script/BUILD failed, ignored
      patch -p1 < 0001-off64t-fix.patch || true
      EXTRA_BAZEL_ARGS="--tool_java_runtime_version=local_jdk" bash ./compile.sh
      mkdir $ROOT/usr/local/bin $ROOT/opt/
      cp -rdp /opt/zulu $ROOT/opt/zulu
      cp -dp /usr/lib/gcc/aarch64-unknown-linux-musl/14/libstdc++.so.6* /usr/lib/gcc/aarch64-unknown-linux-musl/14/libgcc_s.so.1* $ROOT/usr/lib
      cp -dp output/bazel $ROOT/usr/local/bin /usr/local/bin/
 
- name: envoy-base
  tag: 2025.12-2
  section: local
  requires:
  - bazel7-llvm
  type: gentoo-image-builder
  build:
    packages: app-arch/zip
    xadd:
    - git: git@github.com:cainam/cainam.github.io.git#:compile-bazel-with-gentoo-musl-on-aarch64/bazel
      dest: /bazel-build-for-envoy
    configure_builder: |
      cd /var/tmp
      curl -OL https://github.com/libevent/libevent/releases/download/release-2.2.1-alpha/libevent-2.2.1-alpha-dev.tar.gz
      tar xfz libevent-2.2.1-alpha-dev.tar.gz
      cd libevent-2.2.1-alpha-dev
      ./configure --prefix=/usr/local && make && make install
      cd /var/tmp
      curl -LO https://github.com/axboe/liburing/archive/refs/tags/liburing-2.12.tar.gz
      tar xfz liburing-2.12.tar.gz
      cd liburing-liburing-2.12/ && ./configure --prefix=/usr/local && make && make install
      cd /var/tmp
      git clone --single-branch --branch v2.1.ROLLING  --filter=blob:none https://luajit.org/git/luajit.git
      cd luajit/
      make && make install
      for a in /usr/local/include/luajit-2.1/*; do ln -s $a /usr/local/include; done
      cd /var/tmp
      curl -OL https://github.com/gperftools/gperftools/releases/download/gperftools-2.17.2/gperftools-2.17.2.tar.gz
      tar xfz gperftools-2.17.2.tar.gz
      cd gperftools-2.17.2
      ./configure && make && make install
      cd /var/tmp
      #
      git clone https://github.com/cainam/cainam.github.io.git /bazel-build-for-envoy
      for ld in /usr/bin/aarch64-unknown-linux-musl-ld.bfd /usr/sbin/ld.bfd; do 
      mv ${ld} ${ld}.org
      cp -dp /bazel-build-for-envoy/compile-bazel-with-gentoo-musl-on-aarch64/bazel/bin/ld.bfd-wrapper "${ld}"
      done
      #opensuse wlan hotspot
      emerge  llvm-core/lld
- name: envoy
  tag: 2025.12-2
  section: local
  requires:
  - envoy-base
  type: gentoo-image-builder
  build:
    configure_builder: |
      cd /var/tmp; rm -rf * /root/.cache
      export JAVA_HOME=/opt/zulu
      export PATH=/usr/lib/llvm/20/bin/:${JAVA_HOME}/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      export CC=/usr/lib/llvm/20/bin/clang
      git clone --depth 1 --single-branch -b release-1.27 https://github.com/istio/proxy.git; cd proxy
      echo "build --define tcmalloc=gperftools # in .bazelrc" >> .bazelrc
      cp -rv /bazel-build-for-envoy/compile-bazel-with-gentoo-musl-on-aarch64/bazel/* .
      sed -i '/PATH/d' .bazelrc
      sed -e 's/%:libstdc++.a/stdc++/' -e 's/%:libc++.a/c++/g' -e 's/%:libc++abi.a/c++abi/g' -i envoy.bazelrc
      sed -e '/googleurl/d' -i envoy.bazelrc
      emerge dev-libs/icu
      ln -s $PWD /proxy
      for a in $(seq 1 20); do 
      (
      bazel  --output_user_root=$PWD/../cache build --python_path=/usr/bin/python3  --verbose_failures --strip=always --config=sizeopt --toolchain_resolution_debug=1 --copt=-Wno-error --java_runtime_version=local_jdk --tool_java_runtime_version=local_jdk --action_env=PATH=/opt/zulu/bin:$PATH   --action_env=JAVA_HOME=/opt/zulu  --copt="-I /usr/local/include" --copt=-Wno-sign-compare --copt=-Wno-error=deprecated-literal-operator --copt=-Wno-error=sign-compare --copt=-Wno-error=nullability-completeness --copt=-Wno-error --linkopt=-Wl,--no-gdb-index --host_linkopt=-Wl,--no-gdb-index --host_linkopt=-fuse-ld=lld --linkopt=-fuse-ld=bfd --features=-generate_gdb_index --host_features=-generate_gdb_index -c fastbuild --subcommands --check_direct_dependencies=error --logging=6 -- //:envoy; 
      bash -c "echo > /dev/tcp/storage.googleapis.com/443"; 
      bash -c "echo > /dev/tcp/github.com/443"; 
      sleep 10) || true
      done
      bazel  --output_user_root=$PWD/../cache build --python_path=/usr/bin/python3  --verbose_failures --strip=always --config=sizeopt --toolchain_resolution_debug=1 --copt=-Wno-error --java_runtime_version=local_jdk --tool_java_runtime_version=local_jdk --action_env=PATH=/opt/zulu/bin:$PATH   --action_env=JAVA_HOME=/opt/zulu  --copt="-I /usr/local/include" --copt=-Wno-sign-compare --copt=-Wno-error=deprecated-literal-operator --copt=-Wno-error=sign-compare --copt=-Wno-error=nullability-completeness --copt=-Wno-error --linkopt=-Wl,--no-gdb-index --host_linkopt=-Wl,--no-gdb-index --host_linkopt=-fuse-ld=lld --linkopt=-fuse-ld=bfd --features=-generate_gdb_index --host_features=-generate_gdb_index   -c fastbuild   -- //:envoy 
- name: bazel7-llvm
  tag: 2025.09-1
  section: local
  requires:
  - bazel7
  type: gentoo-image-builder
  build:
    configure_builder: emerge llvm-core/clang llvm-runtimes/libcxx
    finish_rootfs_build: |
      cp -dp /bazel/output/bazel /usr/local/bin/

- name: bazel7
  tag: 2025.09-1
  section: local
  requires:
  - python3
  type: gentoo-image-builder
  env:
    JAVA_HOME: /opt/zulu
    USER: root
  build:
    packages: app-arch/zip
    configure_builder: emerge app-arch/zip
    finish_rootfs_build: |
      zulu=zulu21.46.19-ca-jdk21.0.9-linux_musl_aarch64.tar.gz
      ZULU_DIR=/opt/zulu
      curl -O https://cdn.azul.com/zulu/bin/$zulu
      mkdir -p "${ZULU_DIR}" && tar --directory "${ZULU_DIR}" --extract --strip-components=1 --file  $zulu
      export  JAVA_HOME=$ZULU_DIR
      export PATH=$JAVA_HOME/bin:$PATH

      bazel_version=7.6.1
      bazel_dist=bazel-$bazel_version-dist.zip
      mkdir /bazel
      cd bazel
      curl -L -O https://github.com/bazelbuild/bazel/releases/download/$bazel_version/$bazel_dist
      unzip -q $bazel_dist
      #curl "https://gitlab.alpinelinux.org/alpine/aports/-/raw/e49daeab5c9554e8cb7ca23547037d6659d7be43/testing/bazel8/0001-off64t-fix.patch?inline=false" -O
      curl "https://gitlab.alpinelinux.org/alpine/aports/-/raw/e49daeab5c9554e8cb7ca23547037d6659d7be43/testing/bazel7/0001-off64t-fix.patch?inline=false" -O 

      # 8.4 bazel zip, patch applied, but script/BUILD failed, ignored
      patch -p1 < 0001-off64t-fix.patch || true
      sed -i -e 's/"abseil-cpp", version = "20230125.1"/"abseil-cpp", version = "20230802.0"/' MODULE.bazel
      sed -i -e 's/^namespace blaze/#include <cstdint>\nnamespace blaze/g'  src/main/cpp/archive_utils.h
      sed -i -e 's/^namespace blaze/#include <cstdint>\nnamespace blaze/g'  src/main/cpp/blaze.h

      EXTRA_BAZEL_ARGS="--tool_java_runtime_version=local_jdk" bash ./compile.sh
      mkdir $ROOT/usr/local/bin $ROOT/opt/
      find /usr -name "libgcc_s.so.*"
      cp -dp /usr/lib/gcc/aarch64-unknown-linux-musl/*/libstdc++.so.6* /usr/lib/gcc/aarch64-unknown-linux-musl/*/libgcc_s.so.1* $ROOT/usr/lib
      cp -dp output/bazel $ROOT/usr/local/bin
 
- name: auth-operator
  section: auth
  requires:
  - python3
  type: gentoo-image-builder
  build:
    packages: dev-python/idna dev-python/urllib3 dev-python/certifi dev-python/requests
    finish_rootfs_build: |
      VIRTUAL_ENV=/py_env
      python -m venv --system-site-packages "$VIRTUAL_ENV" && . "$VIRTUAL_ENV"/bin/activate && pip install fastapi uvicorn kopf kubernetes
      mv "$VIRTUAL_ENV" ${ROOT}/"$VIRTUAL_ENV"
      
- name: fastapi
  section: local
  requires:
  - python3
  type: gentoo-image-builder
  build:
    packages: dev-python/uvicorn net-misc/curl dev-python/jinja2 dev-python/requests dev-python/typing-extensions dev-python/pyyaml 
    finish_rootfs_build: |
      VIRTUAL_ENV=/py_env
      export PYTHONPATH=${VIRTUAL_ENV}/lib/python3.13/site-packages/
      python -m venv --system-site-packages "$VIRTUAL_ENV" && . "$VIRTUAL_ENV"/bin/activate && pip install fastapi kubernetes
      mv  "${VIRTUAL_ENV}" "${ROOT}/${VIRTUAL_ENV}"

- name: longhorn-manager
  tag: "{{ software.longhorn.version }}"
  section: longhorn-system
  type: fetch
  source: docker.io/longhornio/longhorn-manager

- name: livenessprobe
  tag: v2.17.0-20251030
  section: longhorn-system
  type: fetch
  source: docker.io/longhornio/livenessprobe

- name: backing-image-manager
  tag: "{{ software.longhorn.version }}"
  section: longhorn-system
  type: fetch
  source: docker.io/longhornio/backing-image-manager

- name: csi-attacher
  tag: v4.10.0-20251030
  section: longhorn-system
  type: fetch
  source: docker.io/longhornio/csi-attacher

- name: csi-node-driver-registrar
  tag: v2.15.0-20251030
  section: longhorn-system
  type: fetch
  source: docker.io/longhornio/csi-node-driver-registrar

- name: csi-provisioner
  tag: v5.3.0-20251030
  section: longhorn-system
  type: fetch
  source: docker.io/longhornio/csi-provisioner

- name: csi-resizer
  tag: v1.14.0-20251030
  section: longhorn-system
  type: fetch
  source: docker.io/longhornio/csi-resizer

- name: csi-snapshotter
  tag: v8.4.0-20251030
  section: longhorn-system
  type: fetch
  source: docker.io/longhornio/csi-snapshotter

- name: longhorn-engine
  tag: "{{ software.longhorn.version }}"
  section: longhorn-system
  type: fetch
  source: docker.io/longhornio/longhorn-engine

- name: longhorn-instance-manager
  tag: "{{ software.longhorn.version }}"
  section: longhorn-system
  type: fetch
  source: docker.io/longhornio/longhorn-instance-manager

- name: longhorn-share-manager
  tag: "{{ software.longhorn.version }}"
  section: longhorn-system
  type: fetch
  source: docker.io/longhornio/longhorn-share-manager

- name: longhorn-ui
  tag: "{{ software.longhorn.version }}"
  section: longhorn-system
  type: fetch
  source: docker.io/longhornio/longhorn-ui

- name: support-bundle-kit
  tag: v0.0.71
  section: longhorn-system
  type: fetch
  source: docker.io/longhornio/support-bundle-kit

