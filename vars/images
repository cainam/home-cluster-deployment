images:
- name: base
  section: local
  type: gentoo-image-builder
  test: sh -c 'busybox sh --help'
  build:
    packages: busybox
    configure_rootfs_build: |
      echo "sys-apps/busybox savedconfig" > /etc/portage/package.use/busybox
      EBUILD=$(equery w sys-apps/busybox | head -n1)
      ebuild "$EBUILD" clean unpack configure
      CONFIG_FILE=$(stat --printf="%n" $(portageq envvar PORTAGE_TMPDIR)/portage/*/busybox*/work/busybox*/.config)
      install -D --mode=644 ${CONFIG_FILE} /etc/portage/savedconfig/sys-apps/busybox
      sed -i '/CONFIG_CROND\|CONFIG_AT\|CONFIG_FEATURE_MMC\|CONFIG_FEATURE_USB\|CONFIG_FEATURE_MTD\|CONFIG_PPP\|CONFIG_SLIP\|CONFIG_TELNET\|CONFIG_TFTP\|CONFIG_FTP\|CONFIG_WATCHDOG\|CONFIG_HWCLOCK\|CONFIG_DMESG\|CONFIG_BUNZIP\|CONFIG_BZ\|DHCP\|CONFIG_INIT\|CONFIG_RUN_INIT/s/=y$/=n/' /etc/portage/savedconfig/sys-apps/busybox
    finish_rootfs_build: ln -s usr/lib "${ROOT}/lib" && "${ROOT}"/bin/busybox --install "${ROOT}/bin"

- name: pilot
  tag: "{{ software.istio.version }}"
  section: istio-system
  type: gentoo-image-builder
  requires:
  - go
  build:
    entrypoint: ["/usr/local/bin/pilot-discovery"]
    user: 1337
    configure_rootfs_build: |
      cd /var/tmp
      git clone --depth 1 --single-branch -b {{ software.istio.version }} https://github.com/istio/istio.git
      cd istio/pilot/cmd/pilot-discovery
      CGO_ENABLED=0 go build -ldflags '-extldflags "-static" -s -w'
    finish_rootfs_build: |
      echo 'istio-proxy:x:1337:istio-proxy' > "${ROOT}/etc/group"
      echo 'istio-proxy:x:1337:1337:Linux User,,,:/home/istio-proxy:/bin/sh' > "${ROOT}/etc/passwd"
      mkdir -p "${ROOT}/usr/local/bin" && cp -dp pilot-discovery "${ROOT}/usr/local/bin"
      rm -rf /root/go /root/.cache

- name: postgresql
  section: db
  type: gentoo-image-builder
  requires:
  - base
  env:
    PATH: /usr/lib/postgresql-{{ software.postgresql.version|string|split('.')|first }}/bin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  build:
    entrypoint: ["/usr/bin/postgres"]
    user: postgres
    packages: ="{{ software.postgresql.latest.params.repo }}"-"{{ software.postgresql.version }}"
    configure_builder: |
      mkdir -p /etc/portage/env /etc/portage/package.use
      echo "EXTRA_ECONF=\"LDFLAGS='-Wl,-Bstatic -latomic -Wl,-Bdynamic'\"" > /etc/portage/env/postgres-static-atomic
      echo "dev-db/postgresql postgres-static-atomic" >> /etc/portage/package.env
      echo "dev-db/postgresql -numa" >> /etc/portage/package.use/postgresql
    finish_rootfs_build: |
      ln -s usr/lib "${ROOT}/lib" # && copy_gcc_libs
      (cd ${ROOT}/usr/bin; for f in usr/lib/postgresql*/bin/*; do b=$(basename $f); if [ -e "${b}" ]; then echo "usr/bin/$b exists"; else ln -s /$f; fi; done)
      mkdir -p -m 3777 ${ROOT}/run/postgresql && chown 70 ${ROOT}/run/postgresql
      echo 'postgres:x:70:70:PostgreSQL program user:/var/lib/postgresql:/bin/sh' > "${ROOT}/etc/passwd"
      echo 'postgres:x:70:' > "${ROOT}/etc/group"

- name: go
  section: local
  type: gentoo-image-builder
  requires:
  - base
  build:
    configure_builder: emerge dev-lang/go
    configure_rootfs_build: touch "${ROOT}/ready2go"
      
- name: hydra
  section: auth
  type: gentoo-image-builder
  requires:
  - go
  build:
    configure_rootfs_build: |
      git clone --branch "{{ software.hydra.version }}" --depth 1 --filter=blob:none  https://github.com/ory/hydra.git
      cd hydra
      go build -tags sqlite,sqlite_omit_load_extension .
      strip hydra
      mv hydra "${ROOT}/bin/"

- name: descheduler
  section: kube-system
  type: gentoo-image-builder
  requires:
  - go
  build:
    configure_rootfs_build: |
      git clone --branch "{{ software.descheduler.version }}" --depth 1 --filter=blob:none https://github.com/kubernetes-sigs/descheduler.git
      cd descheduler
      make
      strip ./_output/bin/descheduler
      mkdir -p "${ROOT}/bin"
      mv  ./_output/bin/descheduler "${ROOT}/bin/"

- name: traefik
  section: gateway
  type: gentoo-image-builder
  requires:
  - go
  build:
    configure_builder: |
      echo "net-libs/nodejs npm corepack" > /etc/portage/package.use/97nodejs.conf
      mkdir -p /var/tmp/portage
      mkdir -p /var/db && chmod 755 /var/db
      PORTAGE_TMPDIR="/var/tmp/portage" MAKEOPTS="-j3" emerge net-libs/nodejs dev-libs/icu
    configure_rootfs_build: |
      git clone --depth 1 --single-branch -b "{{ software.traefik.version }}" https://github.com/traefik/traefik.git
      set -x
      cd traefik/webui
      corepack enable
      sed -i -e 's/^}$/,"optionalDependencies": {"@rollup\/rollup-linux-x64-musl": "4.9.5"}}/g' package.json
      rm yarn.lock # ???
      echo "Y" | yarn install
      echo "Y" | yarn workspaces focus --all --production # to keep only production ready deps
      ##npm install -D vitest@^4 @vitest/coverage-v8@^4
      ##npm i
      ##yarn install
      #yarn build
      cd ..
      #(go run ./cmd/internal/gen/ || true)
      #(./script/code-gen.sh || true)
      go generate
      go build -ldflags "-w -s" ./cmd/traefik
    finish_rootfs_build: |
      mkdir -p "${ROOT}/bin" && cp -dp ./traefik "${ROOT}/bin"

- name: oauth2-proxy
  section: auth
  type: gentoo-image-builder
  requires:
  - go
  build:
    entrypoint: ["/bin/oauth2-proxy"]
    configure_rootfs_build: |
      git clone -b "{{ software['oauth2-proxy'].version }}" https://github.com/oauth2-proxy/oauth2-proxy.git
      cd oauth2-proxy
      go build
      strip  oauth2-proxy
      mkdir -p "${ROOT}/bin"
      mv oauth2-proxy "${ROOT}/bin/"
      cd && rm -rf /oauth2-proxy /root/.??* /root/*

- name: registry
  section: local
  type: gentoo-image-builder
  requires:
  - go
  build:
    entrypoint: ["/bin/registry"]
    configure_rootfs_build: |
      git clone -b "{{ software.registry.version }}" https://github.com/distribution/distribution.git
      cd distribution
      make bin/registry
      strip bin/registry
      mkdir "${ROOT}/bin"
      mv bin/registry "${ROOT}/bin/"
      cd ..
      rm -rf distribution /root/.??* /root/*

- name: nodejs
  section: local
  type: gentoo-image-builder
  requires:
  - base
  build:
    packages: net-libs/nodejs
    configure_builder: |
      echo "net-libs/nodejs npm corepack" > /etc/portage/package.use/97nodejs.conf
      echo "dev-lang/typescript ~arm64" > /etc/portage/package.accept_keywords/ts.conf && cat /etc/portage/package.accept_keywords/ts.conf
      MAKEOPTS="-j3" emerge --tree --verbose net-libs/nodejs dev-lang/typescript
    configure_rootfs_build: |
      ln -s usr/lib "${ROOT}/lib"
    finish_rootfs_build: |
      ln -s ../../bin/env "${ROOT}/usr/bin/env"

- name: idp
  section: auth
  type: gentoo-image-builder
  requires:
  - nodejs
  workdir: /app
  build:
    entrypoint: ["/bin/sh", "-c", "npm run serve"]
    configure_rootfs_build: |
      git_url="https://github.com/cainam/sufficient_idp.git"
      git=$(basename "{{ own_git_url }}" | sed -e 's/\.git$//g')
      git clone --single-branch --branch main --depth 1 --filter=blob:none "${git_url}"
      mkdir -p "${ROOT}/app" && mv sufficient_idp/idp/* "${ROOT}/app/"
      rm -rf "${git}"
    finish_rootfs_build: |
      cd "${ROOT}/app/"
      npm ci && npm run build
      npm prune --omit=dev

- name: zigbee2mqtt
  section: home
  type: gentoo-image-builder
  requires:
  - nodejs
  workdir: /app
  env:
    HOME: /app
    PATH: /app/bin:/bin:/usr/bin
  build:
    entrypoint: ["/bin/sh", "-c", "node index.js"]
    configure_rootfs_build: |
      git clone --branch {{ software.zigbee2mqtt.version }} --depth 1 https://github.com/Koenkk/zigbee2mqtt.git "${ROOT}/app"
    finish_rootfs_build: |
      cd "${ROOT}/app/"
      mkdir log
      npm install
      npm run build
      npm rebuild --build-from-source # otherwise segfault- to be tested: cannot it be merge with previous commands?
      npm prune --omit=dev --omit=optional

- name: python3
  section: local
  requires:
  - base
  env:
    LD_LIBRARY_PATH: /usr/local/lib
  type: gentoo-image-builder
  build:
    packages: "dev-python/packaging dev-python/gpep517"
    configure_rootfs_build: |
      echo "*/* sqlite" >> /etc/portage/package.use/builder.conf
      # provide_package sys-devel/gcc
      ln -s usr/lib "${ROOT}/lib"
      # add user/group for unprivileged container usage
      groupadd -g 404 python
      useradd -u 4004 -g python -d /home/python python
      mkdir -p "${ROOT}"/home/python
    finish_rootfs_build: mkdir -p "${ROOT}/usr/local/lib"; #for lib in $(find /usr/lib/ -name libgomp.so.1); do cp "${lib}" "${ROOT}/usr/local/lib"; done

- name: ha-base
  section: home
  requires:
  - python3
  type: gentoo-image-builder
  build:
    packages: "app-misc/jq app-crypt/gnupg dev-python/jinja2 dev-python/idna dev-python/certifi dev-python/requests dev-python/python-dateutil"
    run_with: python3 -m homeassistant --config /config --log-file /tmp/log --skip-pip
    configure_builder: echo 'app-misc/jq -static-libs' > /etc/portage/package.use/jq

- name: home-assistant
  section: home
  requires:
  - ha-base
  type: gentoo-image-builder
  env:
    LD_LIBRARY_PATH: /usr/lib/postgresql-18/lib/:/usr/local/lib
  build:
    packages: dev-db/postgresql
    configure_builder: |
      sed -i -e '/oniguruma/d' -e '/jq/d' /etc/portage/profile/package.provided
      # echo 'dev-db/postgresql -server' > /etc/portage/package.use/postgresql
      # openjade includes opensp whose build breaks https://github.com/Distrotech/OpenSP/blob/master/intl/dcigettext.c - line 154 invalid getcwd definition
      #(cd /var/db/repos/gentoo/dev-db/postgresql/; for f in postgresql-*; do sed -i -e '/openjade/d' $f; ebuild $f manifest; done)
      emerge app-misc/jq 
    configure_rootfs_build: |
      set -x
      HA_DIR=/ha && mkdir -p ${ROOT}/${HA_DIR} && ln -s ${ROOT}/${HA_DIR} ${HA_DIR}
      ( cd ${ROOT}/${HA_DIR}; 
          git clone --depth=1 -b "{{ software['home-assistant'].version }}" https://github.com/home-assistant/core.git
          cd core
          for package in file-read-backwards pyspeex-noise home-assistant-intents PyTurboJPEG home-assistant-frontend pyotp PyQRCode paho-mqtt hassil numpy mutagen ha-ffmpeg hass-nabucasa pymicro-vad; do # pyudev; do
            grep -q "${package}==" requirements.txt  || grep "^${package}==" requirements_all.txt >> requirements.txt
          done
          sed -i -e "/hass_nabucasa/d" -e "s#remote.is_cloud_request.get()#False#" homeassistant/components/http/forwarded.py
            
          # remove from default configuration
          cp -dp homeassistant/components/default_config/manifest.json homeassistant/components/default_config/manifest.json.org
          jq  -a 'del(.dependencies[] | select(. == ("assist_pipeline","stream","go2rtc","cloud","conversation","zeroconf","usb","ssdp","dhcp","mobile_app","bluetooth") ) )' homeassistant/components/default_config/manifest.json.org > homeassistant/components/default_config/manifest.json
      )
      
      VIRTUAL_ENV=/py_env
      python -m venv --system-site-packages "$VIRTUAL_ENV" && . "$VIRTUAL_ENV"/bin/activate
      pip install --no-cache-dir -r ${HA_DIR}/core/requirements.txt 2>&1 | tee ${ROOT}/py_env.log
      rm -rf /py_env/lib/python3.13/site-packages/hass_frontend/frontend_es5 # remove this ancient version 
      set +x
    finish_rootfs_build: |
      set -x
      VIRTUAL_ENV=/py_env
      . "$VIRTUAL_ENV"/bin/activate
      export PATH=$(stat --printf="%n" $ROOT/usr/lib/postgresql-*/bin):$PATH
      pip --no-cache-dir install psycopg2
      find /py_env -name '*.so*' -exec strip {} \;
      pip uninstall --yes uv
      mv "$VIRTUAL_ENV" ${ROOT}/"$VIRTUAL_ENV"
      set +x

- name: mosquitto
  section: home
  requires:
  - base
  type: gentoo-image-builder
  build:
    Xentrypoint: ["/mosquitto/sbin/mosquitto", "-c", "/mosquitto/config/mosquitto.conf" ]
    packages: dev-libs/cJSON dev-libs/openssl dev-libs/libedit net-libs/libmicrohttpd dev-debug/strace # net-libs/libwebsockets 
    finish_rootfs_build: |
      git clone --depth=1 -b "{{ software.mosquitto.version }}" https://github.com/eclipse-mosquitto/mosquitto.git
      mv mosquitto src && cd src
      sed -i -e 's#/usr/local#/mosquitto#g' config.mk
      export CFLAGS="-I${ROOT}/usr/include"
      export CXXFLAGS="-I${ROOT}/usr/include"
      export LDFLAGS="-L${ROOT}/usr/lib"
      make install WITH_DOCS=no # WITH_WEBSOCKETS=yes
      mv /mosquitto ${ROOT}/mosquitto
      echo "mosquitto:x:1883:" >> ${ROOT}/etc/group
      echo "mosquitto:x:1883:1883:mosquitto:/var/empty:/sbin/nologin" >> ${ROOT}/etc/passwd
      strip ${ROOT}/usr/lib/* ${ROOT}/usr/bin/* ${ROOT}/usr/sbin/* || true

- name: envoy-base
  section: local
  requires:
  - bazel7
  type: gentoo-image-builder
  build:
    packages: app-arch/zip
    xadd:
    - git: git@github.com:cainam/cainam.github.io.git#:compile-bazel-with-gentoo-musl-on-aarch64/bazel
      dest: /bazel-build-for-envoy
    configure_builder: |
      emerge llvm-core/clang llvm-runtimes/libcxx llvm-core/lld 
      printf "%s static-libs\n" dev-libs/icu net-dns/c-ares app-arch/zstd net-libs/nghttp2 sys-libs/zlib >> /etc/portage/package.use/static-libs
      emerge -1v net-dns/c-ares app-arch/zstd sys-libs/zlib
      EXTRA_ECONF="--enable-static" emerge -v1 --usepkg=n net-libs/nghttp2
      export PATH=$(stat --printf="%n" /usr/lib/llvm/*/bin):$PATH
      export CC=clang
      export CXX=clang++
      export CONFIGURE="--prefix=/usr/local"
      export CXXFLAGS="-stdlib=libc++ -fPIC"
      export LDFLAGS="-stdlib=libc++"
      export LIBS="-lc++ -lc++abi"
      cd /var/tmp
      git clone --single-branch --depth 1 -b release-77-1 https://github.com/unicode-org/icu.git
      cd icu/icu4c/source/
      ./configure $CONFIGURE --enable-static --disable-shared --with-library-bits=64 --disable-samples --disable-tests # --disable-renaming
      make -j 3 && make install
      cd /var/tmp
      curl -LO https://github.com/axboe/liburing/archive/refs/tags/liburing-2.12.tar.gz
      tar xfz liburing-2.12.tar.gz
      cd liburing-liburing-2.12/ && ./configure $CONFIGURE && make && make install
      #export CONFIGURE="$CONFIGURE --enable-shared=no --enable-static=yes --enable-pic=yes"
      cd /var/tmp
      curl -OL https://github.com/libevent/libevent/releases/download/release-2.2.1-alpha/libevent-2.2.1-alpha-dev.tar.gz
      tar xfz libevent-2.2.1-alpha-dev.tar.gz
      cd libevent-2.2.1-alpha-dev; ./configure $CONFIGURE && make && make install
      cd /var/tmp
      git clone --single-branch --branch v2.1.ROLLING  --filter=blob:none https://luajit.org/git/luajit.git
      cd luajit/; make && make install
      for a in /usr/local/include/luajit-2.1/*; do ln -s $a /usr/local/include; done
      cd /var/tmp
      #
      git clone https://github.com/cainam/cainam.github.io.git /bazel-build-for-envoy
      for ld in /usr/bin/aarch64-unknown-linux-musl-ld.bfd /usr/sbin/ld.bfd; do 
      mv ${ld} ${ld}.org
      cp -dp /bazel-build-for-envoy/compile-bazel-with-gentoo-musl-on-aarch64/bazel/bin/ld.bfd-wrapper "${ld}"
      done
      # remove the following line again, it is in bazel7
      cp -dp /bazel/output/bazel /usr/local/bin/

- name: proxyv2
  section: istio-system
  tag: "{{ software.istio.version }}"
  requires:
  - envoy
  type: gentoo-image-builder
  build:
    entrypoint: ["/usr/local/bin/pilot-agent"]
    user: 1337
    configure_builder: |
      emerge dev-lang/go
    configure_rootfs_build: |
      cd /var/tmp
      [ -d "istio" ] && rm -rf istio; git clone --depth 1 --single-branch -b release-1.27 https://github.com/istio/istio.git
      cd istio/pilot/cmd/pilot-agent
      CGO_ENABLED=0 go build -ldflags '-extldflags "-static" -s -w'
    finish_rootfs_build: |
      echo 'istio-proxy:x:1337:istio-proxy' > "${ROOT}/etc/group"
      echo 'istio-proxy:x:1337:1337:Linux User,,,:/home/istio-proxy:/bin/sh' > "${ROOT}/etc/passwd"
      mkdir -p "${ROOT}/usr/local/bin" && cp -dp pilot-agent "${ROOT}/usr/local/bin"
      mkdir -p "${ROOT}/var/lib/istio/envoy/" && cp -dp ../../../tools/packaging/common/envoy_bootstrap.json "${ROOT}/var/lib/istio/envoy/envoy_bootstrap_tmpl.json"
      rm -rf /root/go /root/.cache

- name: envoy
  section: local
  tag: "{{ software.istio.version }}"
  requires:
  - envoy-base
  type: gentoo-image-builder
  build:
    configure_builder: |
      # use build:libc++ --linkopt=-rtlib=compiler-rt and build:libc++ --linkopt=-unwindlib=libunwind instead of libunwind
      cd /var/tmp; rm -rf * /root/.cache
      export JAVA_HOME=/opt/zulu
      export PATH=$(stat --printf="%n" /usr/lib/llvm/*/bin):${JAVA_HOME}/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      export CC=$(which clang)
      #USE="$USE static-libs" emerge llvm-runtimes/libunwind
      git clone --depth 1 --single-branch -b {{ software.istio.version }} https://github.com/istio/proxy.git; cd proxy
      echo "build --define tcmalloc=disabled # in .bazelrc" >> .bazelrc
      cp -rv /bazel-build-for-envoy/compile-bazel-with-gentoo-musl-on-aarch64/bazel/* .
      sed -i -e '/repo:http/r add-pt1.txt' -e '/url = /r add-pt2.txt' WORKSPACE
      sed -i '/PATH/d' .bazelrc
      #sed -i -e 's/libc++abi\.a/libc++abi.a:-l%:libunwind.a/'  envoy.bazelrc 
      sed -e '/googleurl/d' -i envoy.bazelrc
      sed -i -e '/ip_range_matc/d' bazel/extension_config/extensions_build_config.bzl
      sed -e '/istio_stats/d' -e '/workload_discovery/d' -e '/^envoy_cc_binary/e cat add2BUILD.txt' -e '/envoy_cc_binary(/,/^)/d' -i BUILD 
      sed -i -e '/metadata/d' BUILD
      echo -e '#include "source/exe/main_common.h"\nextern "C" {\nconst char build_scm_revision[] = "'$(git rev-parse HEAD)'"\nconst char build_scm_status[] = "clean";\n}\nint main(int argc, char** argv) {return Envoy::MainCommon::main(argc, argv);}' > main.cc
      ln -s $PWD /proxy
      #bazel_options='--python_path=/usr/bin/python3.13  --verbose_failures --strip=always --config=sizeopt --toolchain_resolution_debug=1 --copt=-Wno-error --java_runtime_version=local_jdk --tool_java_runtime_version=local_jdk --action_env=PATH='$PATH'  --action_env=JAVA_HOME=/opt/zulu  --copt=-I/usr/local/include --copt=-Wno-sign-compare --copt=-Wno-error=deprecated-literal-operator --copt=-Wno-error=sign-compare --copt=-Wno-error=nullability-completeness --copt=-Wno-error --linkopt=-Wl,--no-gdb-index --host_linkopt=-static --linkopt=-static --host_linkopt=-Wl,--no-gdb-index --host_linkopt=-fuse-ld=lld --linkopt=-fuse-ld=bfd --features=-generate_gdb_index --host_features=-generate_gdb_index --copt=-Wno-error  --cxxopt=-Wno-error --copt=-Wno-unused-parameter --cxxopt=-Wno-unused-parameter  --cxxopt=-Wno-error=unused-parameter --linkopt=-nostdlib++ --host_linkopt=-nostdlib++  -c fastbuild --define=musl=true --host_linkopt=-rtlib=compiler-rt --host_linkopt=-unwindlib=libunwind --host_linkopt=/usr/lib/libc.a  --linkopt=/usr/local/lib/libicui18n.a   --linkopt=/usr/local/lib/libicuuc.a --linkopt=/usr/local/lib/libicudata.a '
      bazel_options='--python_path=/usr/bin/python3.13  --verbose_failures --strip=always --config=sizeopt --toolchain_resolution_debug=1 --copt=-Wno-error --java_runtime_version=local_jdk --tool_java_runtime_version=local_jdk --action_env=PATH='$PATH'  --action_env=JAVA_HOME=/opt/zulu  --copt=-I/usr/local/include --copt=-Wno-sign-compare --copt=-Wno-error=deprecated-literal-operator --copt=-Wno-error=sign-compare --copt=-Wno-error=nullability-completeness --copt=-Wno-error --linkopt=-Wl,--no-gdb-index --host_linkopt=-static --linkopt=-static --host_linkopt=-Wl,--no-gdb-index --host_linkopt=-fuse-ld=lld --linkopt=-fuse-ld=bfd --features=-generate_gdb_index --host_features=-generate_gdb_index --copt=-Wno-error  --cxxopt=-Wno-error --copt=-Wno-unused-parameter --cxxopt=-Wno-unused-parameter  --cxxopt=-Wno-error=unused-parameter --linkopt=-nostdlib++ --host_linkopt=-nostdlib++  -c fastbuild --define=musl=true --host_linkopt=-rtlib=compiler-rt --host_linkopt=/usr/lib/libc.a  --linkopt=/usr/local/lib/libicui18n.a   --linkopt=/usr/local/lib/libicuuc.a --linkopt=/usr/local/lib/libicudata.a '
      bazel_options='--python_path=/usr/bin/python3.13  --verbose_failures --strip=always --config=release --toolchain_resolution_debug=1 --copt=-Wno-error --java_runtime_version=local_jdk --tool_java_runtime_version=local_jdk --action_env=PATH='$PATH'  --action_env=JAVA_HOME=/opt/zulu  --copt=-I/usr/local/include --copt=-Wno-sign-compare --copt=-Wno-error=deprecated-literal-operator --copt=-Wno-error=sign-compare --copt=-Wno-error=nullability-completeness --copt=-Wno-error --linkopt=-Wl,--no-gdb-index --host_linkopt=-static --linkopt=-static --host_linkopt=-Wl,--no-gdb-index --host_linkopt=-fuse-ld=lld --linkopt=-fuse-ld=bfd --features=-generate_gdb_index --host_features=-generate_gdb_index --copt=-Wno-error  --cxxopt=-Wno-error --copt=-Wno-unused-parameter --cxxopt=-Wno-unused-parameter  --cxxopt=-Wno-error=unused-parameter --linkopt=-nostdlib++ --host_linkopt=-nostdlib++  --define=musl=true --host_linkopt=-rtlib=compiler-rt --host_linkopt=/usr/lib/libc.a  --linkopt=/usr/local/lib/libicui18n.a   --linkopt=/usr/local/lib/libicuuc.a --linkopt=/usr/local/lib/libicudata.a '
      until bazel --output_user_root=$PWD/../cache fetch ${bazel_options}   -- //:envoy; do echo "retry in some seconds..."; sleep 5; done
      bazel  --output_user_root=$PWD/../cache build ${bazel_options} --stamp -- //:envoy
    finish_rootfs_build: |
      strip bazel-bin/envoy
      cp -dp bazel-bin/envoy  ${ROOT}/usr/local/bin/
      # cp /lib/libc++.so.* /lib/libc++abi.so.*  /lib/libicudata.so.* /usr/lib/gcc/aarch64-unknown-linux-musl/*/lib* ${ROOT}/usr/local/lib/ || true
      #cp -dp /lib/libicudata.so.* /usr/lib/libicuuc* ${ROOT}/usr/local/lib/ || true

- name: bazel7
  section: local
  requires:
  - base
  type: gentoo-image-builder
  env:
    JAVA_HOME: /opt/zulu
    USER: root
  build:
    packages: app-arch/zip
    configure_builder: emerge app-arch/zip 
    finish_rootfs_build: |
      # https://cdn.azul.com/zulu/bin/zulu25.32.17-ca-jdk25.0.2-linux_musl_aarch64.tar.gz
      zulu=zulu21.48.15-ca-jdk21.0.10-linux_musl_aarch64.tar.gz
      ZULU_DIR=/opt/zulu
      curl -O https://cdn.azul.com/zulu/bin/$zulu
      mkdir -p "${ZULU_DIR}" && tar --directory "${ZULU_DIR}" --extract --strip-components=1 --file  $zulu
      export  JAVA_HOME=$ZULU_DIR
      export PATH=$JAVA_HOME/bin:$PATH

      bazel_version=7.7.1
      bazel_dist=bazel-$bazel_version-dist.zip
      mkdir /bazel && cd bazel
      curl -L -O https://github.com/bazelbuild/bazel/releases/download/$bazel_version/$bazel_dist
      unzip -q $bazel_dist
      curl https://gitlab.alpinelinux.org/alpine/aports/-/raw/master/testing/bazel7/0001-off64t-fix.patch?ref_type=heads -O
      patch -p1 < 0001-off64t-fix.patch || true
     
      BAZEL_DEV_VERSION_OVERRIDE="${bazel_version}"  EXTRA_BAZEL_ARGS="--tool_java_runtime_version=local_jdk" bash ./compile.sh
      mkdir -p $ROOT/usr/local/bin 
      find /usr -name "libgcc_s.so.*"
      cp -dp /bazel/output/bazel /usr/local/bin/
 
- name: auth-operator
  section: auth
  requires:
  - python3
  type: gentoo-image-builder
  build:
    packages: dev-python/idna dev-python/urllib3 dev-python/certifi dev-python/requests
    finish_rootfs_build: |
      VIRTUAL_ENV=/py_env
      python -m venv --system-site-packages "$VIRTUAL_ENV" && . "$VIRTUAL_ENV"/bin/activate && pip install fastapi uvicorn kopf kubernetes
      mv "$VIRTUAL_ENV" ${ROOT}/"$VIRTUAL_ENV"
      
- name: fastapi
  section: local
  requires:
  - python3
  type: gentoo-image-builder
  build:
    packages: dev-python/uvicorn net-misc/curl dev-python/jinja2 dev-python/requests dev-python/typing-extensions dev-python/pyyaml 
    finish_rootfs_build: |
      VIRTUAL_ENV=/py_env
      export PYTHONPATH=${VIRTUAL_ENV}/lib/python3.13/site-packages/
      python -m venv --system-site-packages "$VIRTUAL_ENV" && . "$VIRTUAL_ENV"/bin/activate && pip install fastapi kubernetes
      mv  "${VIRTUAL_ENV}" "${ROOT}/${VIRTUAL_ENV}"

- name: flannel
  section: kube-flannel
  type: fetch
  source: ghcr.io/flannel-io/flannel

- name: flannel-cni-plugin
  section: kube-flannel
  type: fetch
  source: ghcr.io/flannel-io/flannel-cni-plugin
