- name: prepare applications
  debug:
    msg: "namespace: {{ item }} application: {{ applications[item] }}" 
  with_items: "{{ applications.keys() | list }}"
  
- name: check if container registry is available
  shell: curl -s --cacert /data/certs/myCA.pem -X GET https://myregistry.adm13:443/v2/_catalog | jq 'has("repositories")'
  register: check_registry
  
- name: restart registry
  shell: /etc/init.d/run-registry restart
  when: check_registry.stdout != "true"

- name: init required volumes
  set_fact:
    keep_volumes: "{{ volumes_to_exempt }}"

- name: prepare application prerequisites
  include_tasks: prepare_by_namespace.yml
  loop: "{{ applications | dict2items }}"
  loop_control:
    loop_var: namespace

- name: run per namespace
  include_tasks: manage_applications.yml
  loop: "{{ applications | dict2items }}"
  loop_control:
    loop_var: namespace
  run_once: true
  
- name: list volumes to keep
  debug:
    msg: "{{ item }}"
  loop: "{{ keep_volumes }}"
  run_once: true
  
- name: list of existing volumes
  shell: gluster vol list
  run_once: true
  register: existing_volumes

- name: determine volumes for deletion
  set_fact:
    volume2delete: "{{ existing_volumes.stdout_lines | difference(keep_volumes) }}"
  run_once: true

- name: list volumes to delete
  debug:
    msg: "{{ item }}"
  loop: "{{ volume2delete }}"
  run_once: true
  
- block:
    - name: purge volumes - get bricks
      shell: |
        gluster vol info "{{ item }}" | grep "^Brick[0-9]" | cut -d : -f 3- | sort -u
      loop: "{{ volume2delete }}"
      run_once: true
      register: get_bricks_out
      
    - debug: var=get_bricks_out

    - name: purge volumes - delete volume
      gluster.gluster.gluster_volume:
        state: absent
        name: "{{ item }}"
      loop: "{{ volume2delete }}"
      run_once: true
      
    - name: purge volumes - delete bricks
      shell: |
        umount -v "{{ item.1 }}"
        echo "{{ item.1 }}" | grep -q "^/data/gluster/bricks/" && rm -rfv "{{ item.1 }}"
      #loop: "{{ get_bricks_out.stdout_lines }}"      
      with_subelements:
         - "{{ get_bricks_out.results }}"
         - stdout_lines
  
  when: "'purge_volumes' in ansible_run_tags" 

