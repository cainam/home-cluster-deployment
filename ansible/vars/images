images:
- type: script
  name: helm
  tag: "{{ software.helm.version }}"
  requires:
  - my_base
  command: |
    cat > Dockerfile << EOF
    FROM my_base:{{ software.alpine.version }}
    RUN curl -s https://get.helm.sh/helm-v{{ software.helm.version }}-linux-{{ default_platform }}.tar.gz  | tar -xz && mv linux-{{ default_platform }}/helm /usr/bin/helm && chmod +x /usr/bin/helm && rm -rf linux-{{ default_platform }}
    ENTRYPOINT ["helm"]
    CMD ["--help"]
    EOF
    podman image build . --tag "${image}" && podman image push "${image}"
  section: local
- type: script
  name: my_py
  tag: 3
  section: local
  requires:
  - my_base
  command: |
    cat > Dockerfile << EOF
    FROM my_base:{{ software.alpine.version }}
    RUN apk add --no-cache gnupg openssl xz python3 py3-pip py3-psycopg2 libturbojpeg ffmpeg
    EOF
    podman image build . --tag "${image}" && podman image push "${image}"
- type: fetch
  source: docker.io/library/registry
  tag: "{{ software.registry.version }}"
  section: local
- type: script
  name: my_base
  tag: "{{ software.alpine.version }}"
  section: local
  command: |
    version="{{ software.alpine.version }}" 
    version_short=$(echo "${version}" | sed -e 's/^v//g')
    version_tag=${version%.*}
    minirootfs="alpine-minirootfs-${version_short}-aarch64.tar.gz"
    curl -L -O "https://github.com/alpinelinux/docker-alpine/raw/refs/heads/${version_tag}/aarch64/${minirootfs}"
    cat > Dockerfile << EOF
    FROM scratch
    ADD ${minirootfs} /
    RUN apk add --no-cache tar binutils curl
    CMD ["/bin/sh"]
    EOF
    podman image build . --tag "${image}" && podman image push "${image}"
